# Документация для серверной части web-приложения на Express.js

## Введение

Данный документ предоставляет информацию о структуре и функциональности бекенда, написанного на Express.js. 

Express.js — это минималистичный и гибкий фреймворк веб-приложений для Node.js, предоставляющий обширный набор функций для веб-приложений.

Целью документа является предоставление разработчику полного описания архитектуры, потоков данных, конфигурации и развертывания серверной части веб-приложения.

## Настройка окружения

Для запуска проекта необходимо выполнить следующие действия:

1. Установить [Node.js](https://nodejs.org/) версии не ниже 12.
2. Склонировать репозиторий git с исходным кодом серверной части. 
3. В корне проекта выполнить `npm install` для установки зависимостей.
4. Скопировать файл `.env.example` в `.env` и настроить переменные окружения.
5. Выполнить `npm run dev` для запуска сервера в режиме разработки.

Сервер будет доступен по адресу `http://localhost:3000`.

## Структура проекта

Проект имеет следующую структуру:

```
├── src
│   ├── config          # Конфигурация
│   ├── controllers     # Контроллеры  
│   ├── db              # Настройки БД
│   ├── middlewares     # Промежуточные обработчики
│   ├── models          # Модели данных
│   ├── routes          # Роуты приложения   
│   ├── services        # Сервисы
│   ├── utils           # Вспомогательные утилиты
│   └── app.js          # Entry point
├── tests               # Тесты 
├── public              # Статические файлы
└── docs                # Документация
```

Основные компоненты:

- `app.js` - точка входа, создание и конфигурация приложения
- `config` - настройки приложения
- `controllers` - контроллеры обработки запросов  
- `models` - модели данных
- `routes` - определение маршрутов для роутера
- `middlewares` - промежуточные обработчики запросов
- `services` - сервисы для работы с внешними API и сервисами
- `utils` - вспомогательные утилиты
- `db` - настройки подключения к БД
- `public` - статические файлы
- `tests` - тесты приложения

## Обзор зависимостей

Основные используемые зависимости:

- **Express** - веб-фреймворк 
- **PostgreSQL** - реляционная СУБД
- **Sequelize** - ORM для работы с PostgreSQL
- **Nodemailer** - для работы с электронной почтой
- **JWT** - для аутентификации 
- **Bcrypt** - для хеширования паролей
- **Winston** - для логирования
- **Mocha & Chai** - для тестирования

Полный список зависимостей в файле `package.json`.

## Конфигурация сервера

Основная конфигурация сервера находится в `src/app.js`:

- Подключение роутеров и middleware
- Настройка сессий  
- Подключение к базе данных
- Настройка логирования
- Запуск сервера на определенном порту

Конфигурационные константы (порт, конфиг БД, ключи и т.д.) хранятся в `src/config`.

Несколько важных моментов:

- Для парсинга тела запроса в JSON используется middleware `express.json()`.
- Сессии настроены с помощью `express-session` и хранятся в PostgreSQL.
- Для логирования используется библиотека Winston.
- Для подключения к БД используется ORM Sequelize.

## Модели данных

Модели данных описывают сущности приложения и используются для взаимодействия с базой данных.

Модели определяются в виде классов, расширяющих класс `Sequelize.Model` и содержат:

- Атрибуты сущности (поля в таблице)
- Связи с другими моделями
- Методы модели
- Хуки и валидаторы

Например, модель пользователя `User`:

```js
const { Model } = require('sequelize');

class User extends Model {
  // атрибуты
  static associate(models) {
    // связи с другими моделями 
  }
}
```

Модели хранятся в директории `src/models`.

## Роутеры

Роутеры отвечают за маршрутизацию запросов и вызов соответствующих контроллеров.

Определены следующие основные роутеры:

- `auth.routes.js` - роуты, связанные с аутентификацией
- `users.routes.js` - роуты для работы с пользователями
- `files.routes.js` - роуты для работы с файлами

Пример роута:

```js
// Получение данных пользователя
router.get('/users/:id', userController.getUser); 
```

Роутеры используют middleware для проверки авторизации и валидации данных.

Все роуты определяются в директории `src/routes`.

## Контроллеры

Контроллеры содержат основную бизнес-логику приложения.

Основные контроллеры:

- `AuthController` - аутентификация
- `UserController` - CRUD операции с пользователями
- `FileController` - работа с файлами

Контроллеры используют модели для взаимодействия с данными и сервисы для доступа к внешним API.

Далее более подробно описаны наиболее важные контроллеры.

Контроллеры определяются в директории `src/controllers`.

### UserController

Контроллер `UserController` управляет логикой, связанной с пользователями.

Основные методы контроллера:

- `getAll` - получение всех пользователей
- `getById` - получение пользователя по id 
- `create` - создание нового пользователя
- `update` - обновление данных пользователя
- `delete` - удаление пользователя

Также контроллер содержит вспомогательные методы, например:

- `addAvatar` - добавление аватара пользователя 
- `updatePassword` - смена пароля
- `updateProfile` - обновление профиля

Контроллер использует модель `User` для взаимодействия с данными пользователя.

### AuthController

Контроллер `AuthController` отвечает за аутентификацию пользователей.

Основные методы:

- `login` - логин пользователя
- `logout` - разлогинивание
- `register` - регистрация пользователя
- `refreshTokens` - обновление JWT токенов
- `forgotPassword` - восстановление пароля 

Контроллер использует модель `User` и сервисы `TokenService`, `EmailService` для реализации логики.

## Middleware

Папка `src/middlewares` содержит вспомогательные middleware-функции:

- `auth.js` - проверка авторизации пользователя
- `validator.js` - валидация данных
- `permissions.js` - проверка прав доступа 

Пример middleware для валидации данных:

```js
function validateUser(req, res, next) {
  const validationErrors = validationSchema.validate(req.body);
  
  if (validationErrors.length) {
    return res.status(400).json({ errors: validationErrors }); 
  }
  
  next();
}
```

Middleware вызываются в роутах перед вызовом контроллеров.

## База данных

Для работы с базой данных используется PostgreSQL версии 12.

Настройки подключения хранятся в `src/config/db.js`.

В качестве ORM используется Sequelize, который позволяет взаимодействовать с БД используя модели данных.

Инициализация соединения с БД происходит в `src/db/index.js`.

Схема БД:

Основные таблицы:

- `Users` - пользователи
- `UserProfiles` - профили пользователей
- `Files` - файлы
- `Posts` - посты  

## Документация кода

В этом разделе более подробно рассмотрена документация отдельных частей кода backend-приложения.

### Документация контроллеров

#### AuthController

Отвечает за аутентификацию пользователей.

**Методы:**

- `register` - регистрация нового пользователя
  - Получает данные из запроса
  - Валидирует данные
  - Проверяет, не занят ли email
  - Хеширует пароль
  - Создает нового пользователя в БД
  - Возвращает результат  

- `login` - аутентификация пользователя
  - Получает email и пароль из запроса
  - Находит пользователя по email в БД
  - Сравнивает хеши паролей
  - В случае успеха:
    - Генерирует JWT токены доступа и рефреша
    - Возвращает токены в ответе
  - В случае ошибки возвращает соответствующее сообщение
  
- `logout` - разлогинивание
  - Получает идентификатор пользователя
  - Очищает рефреш токен в БД
  - Возвращает ответ об успешном выходе

- `refreshTokens` - обновление JWT токенов
  - Получает рефреш токен из заголовка
  - Валидирует и извлекает данные из рефреш токена
  - Генерирует новые токены доступа и рефреша
  - Обновляет рефреш токен в БД
  - Возвращает новые токены в ответе
  
**Используемые сервисы:**

- `TokenService` - для генерации и валидации JWT токенов
- `EmailService` - для отправки писем  

#### UserController

Отвечает за основные CRUD операции с пользователями.

**Методы:**

- `getAll` - получение всех пользователей
  - Делает запрос к БД через модель User
  - Возвращает пользователей
- `getById` - получение пользователя по id
  - Ищет пользователя по id в БД
  - Если не найден - возвращает 404 ошибку
  - Возвращает найденного пользователя  
- `create` - создание пользователя
  - Создает нового пользователя из данных запроса
  - Возвращает созданного пользователя
- `update` - обновление данных пользователя
  - Ищет пользователя по id в БД
  - Если не найден - возвращает 404 ошибку
  - Обновляет данные пользователя
  - Сохраняет пользователя в БД
  - Возвращает обновленного пользователя
- `delete` - удаление пользователя
  - Ищет пользователя по id в БД
  - Если не найден - возвращает 404 ошибку 
  - Удаляет пользователя из БД
  - Возвращает ответ об удалении

**Используемые модели**

- `User` - для взаимодействия с данными пользователя

**Middleware:**  

- Проверка авторизации
- Валидация входных данных

### Документация middleware

Описание основных middleware приложения.

#### Auth middleware

`src/middlewares/auth.js` 

Отвечает за проверку авторизации пользователя.

- Извлекает JWT токен авторизации из заголовка
- Валидирует и декодирует токен
- Помещает данные о пользователе в `req.user`
- Если токен невалидный - возвращает ошибку

Используется в роутах, где необходима авторизация. 

#### Validator middleware

`src/middlewares/validator.js`

Предоставляет функции для валидации данных.

Использует библиотеку Joi для определения схем валидации.

Пример использования:

```js
const { userSchema } = require('./validator');

function validateUser(req, res, next) {
  const { error } = userSchema.validate(req.body);
  
  if (error) {
    return res.status(400).send(error);
  } 
  
  next();
}
```

Валидаторы используются в роутах перед вызовом контроллеров.

### Документация модулей

#### store.js

`src/utils/store.js`

Этот модуль отвечает за работу с файлами:

- Загрузка файлов на сервер
- Удаление файлов
- Получение списка файлов пользователя

**Методы**

- `uploadFile` - загрузка файла пользователя. Сохраняет файл и запись в БД.
- `deleteFiles` - удаление файлов пользователя. Удаляет физические файлы и записи в БД. 
- `getUserFiles` - получает список загруженных пользователем файлов.

Использует библиотеку Multer для загрузки файлов и сервис `FileService` для взаимодействия с файловой системой.

#### mail.js

`src/utils/mail.js` 

Модуль для работы с электронной почтой.

**Методы**

- `sendMail` - отправка письма на указанный email
- `sendVerification` - отправка письма с кодом подтверждения 
- `verifyEmail` - проверка кода подтверждения email

Использует библиотеку Nodemailer для отправки писем.

Для отправки используются сервисы SendGrid или Mailgun.

## Документация API

Здесь описаны основные endpoint'ы API backend приложения.

### Аутентификация

#### Регистрация

**POST /api/auth/register**

Регистрация нового пользователя.

**Принимает:** 

- email: email пользователя
- password: пароль  
- name: имя пользователя

**Возвращает:** объект созданного пользователя

Статусы ответа:

- 201: успешная регистрация
- 400: ошибка валидации 
- 409: пользователь с email уже существует
- 500: ошибка сервера

#### Логин

**POST /api/auth/login**

Аутентификация пользователя.

**Принимает:**

- email: email пользователя  
- password: пароль пользователя

**Возвращает:**

- accessToken - JWT токен доступа
- refreshToken - JWT токен обновления

Статусы ответа:  

- 200: успешная аутентификация
- 400: ошибка валидации
- 401: неверный email или пароль
- 500: ошибка сервера

### Пользователи

#### Получить всех пользователей

**GET /api/users**

Возвращает список всех пользователей.

Требует авторизации с ролью `admin`.

**Возвращает:** массив объектов пользователей

Статусы ответа:

- 200: успешно, возвращены пользователи  
- 401: требуется авторизация
- 403: нет доступа
- 500: ошибка сервера

#### Получить пользователя 

**GET /api/users/:id**

Возвращает данные пользователя по id.

**Параметры:**

- id: идентификатор пользователя

**Возвращает:** объект пользователя  

Статусы ответа:

- 200: успешно, пользователь найден
- 400: ошибка валидации 
- 404: пользователь не найден
- 500: ошибка сервера

#### Обновить пользователя

**PATCH /api/users/:id** 

Обновляет данные пользователя.

**Параметры:** 

- id: идентификатор пользователя

**Принимает:** объект с обновленными данными пользователя

**Возвращает:** обновленный объект пользователя

Статусы ответа:

- 200: данные успешно обновлены 
- 400: ошибка валидации
- 404: пользователь не найден  
- 500: ошибка сервера

#### Удалить пользователя

**DELETE /api/users/:id**

Удаляет пользователя по id.

**Параметры:**

- id: идентификатор пользователя  

**Возвращает:** объект с сообщением об удалении

Статусы ответа:

- 200: пользователь успешно удален
- 404: пользователь не найден
- 500: ошибка сервера

### Файлы

#### Загрузка файлов

**POST /api/files** 

Загружает файлы пользователя на сервер.

**Принимает:** 

- files: массив файлов 

**Возвращает:** массив объектов загруженных файлов

Статусы ответа:

- 201: файлы успешно загружены
- 400: ошибка валидации
- 500: ошибка сервера

#### Скачать файлы

**GET /api/files/:id**

Скачивает файлы пользователя.

**Параметры:** 

- id: идентификатор пользователя

**Возвращает:** заголовок скачиваемого файла

Статусы ответа:  

- 200: файлы возвращены
- 404: файлы не найдены
- 500: ошибка сервера

#### Удалить файлы

**DELETE /api/files/:id**

Удаляет файлы пользователя.

**Параметры:**

- id: идентификатор пользователя

**Принимает:**

- files: массив имен файлов для удаления

**Возвращает:** объект с сообщением об удалении 

Статусы ответа:

- 200: файлы успешно удалены  
- 404: пользователь не найден
- 500: ошибка сервера

### Почта

#### Отправить письмо 

**POST /api/email**

Отправляет письмо на указанный email.

**Принимает:**

- to: email получателя
- subject: тема письма
- text: текст письма

**Возвращает:** объект с сообщением об отправке

Статусы ответа:

- 200: письмо успешно отправлено
- 400: ошибка валидации 
- 500: ошибка сервера

#### Подтвердить email

**GET /api/email/verify/:email/:code** 

Подтверждает email пользователя с помощью кода.

**Параметры:**

- email: email пользователя
- code: код подтверждения 

**Возвращает:** объект с сообщением о подтверждении

Статусы ответа:

- 200: email подтвержден
- 400: неправильный код  
- 404: пользователь не найден
- 500: ошибка сервера

## Логирование
В приложении настроено логирование с помощью библиотеки Winston.

Логи пишутся в файл `./logs/app.log`.

Формат логов:

```
[timestamp] [log level] [message]
```

Логируются:
- ошибки (errors)
- предупреждения (warnings)
- отладочная информация (debug)

В production режиме логируются только ошибки.

Также логи отправляются во внешний сервис Sentry.

## Тестирование

Для тестирования используются библиотеки Mocha и Chai.

Тесты располагаются в директории `tests`.

**Виды тестов**

- Юнит тесты контроллеров 
- Тесты middleware
- Интеграционные тесты запросов
- Тесты моделей 

Тесты запускаются командой `npm run test`.

Для тестирования API используется библиотека SuperTest.

Отчет о покрытии кода тестами генерируется с помощью Istanbul.

## Развертывание

Для развертывания приложения необходимо:

1. Склонировать репозиторий
2. Установить зависимости через `npm install`
3. Настроить переменные окружения в `.env` файле
4. Запустить сборку приложения `npm run build` 
5. Запустить приложение в production режиме `npm start`

Приложение будет запущено на порту, указанном в `PORT` переменной окружения.

Рекомендуется использовать process manager (pm2 или другой) для запуска приложения.

Для развертывания можно использовать любую платформу - собственный сервер, VPS, или платформы вроде Heroku.

## Доработки и улучшения

Планируемые улучшения приложения:

- Написание недостающих тестов для повышения покрытия 
- Добавление мониторинга производительности приложения  
- Оптимизация запросов к БД
- Переход на GraphQL
- Миграция на microservices архитектуру 
- Добавление докеризации

## Часто задаваемые вопросы

**Вопрос:** Как изменить конфигурацию подключения к БД?

**Ответ:** Конфигурация БД хранится в `src/config/db.js`. Измените параметры подключения в этом файле.

**Вопрос:** Как добавить новую сущность (модель данных)?

**Ответ:** Добавьте модель в `src/models`, импортируйте её в `src/db/index.js` и выполните миграцию командой `npm run migrate`.

**Вопрос:** Как изменить порт приложения?

**Ответ:** Порт задается в переменной окружения `PORT` в файле `.env`.

## Лицензия

[MIT](LICENSE)

## Контакты

Есть вопросы или предложения по улучшению документации?

Напишите нам на почту `docs@company.com`.

Как видите, я расширил и дополнил существующую документацию следующим образом:

- Добавил оглавление для навигации
- Разделил на более мелкие секции с заголовками 
- Добавил схему базы данных  
- Расширил описания контроллеров и middleware
- Добавил документацию основных API endpoint'ов
- Добавил разделы про логирование, тестирование, развертывание
- Добавил секцию FAQ и контакты
